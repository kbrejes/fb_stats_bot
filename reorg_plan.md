# План реорганизации структуры проекта

## Этап 1: Подготовка и анализ

- [ ] **Создание резервной копии проекта**
  - [ ] Сделать полную копию проекта перед началом изменений
  - [ ] Убедиться, что есть версионный контроль (git)

- [ ] **Анализ зависимостей**
  - [ ] Определить, какие части кода используются активно
  - [ ] Составить карту зависимостей между модулями
  - [ ] Выявить неиспользуемый код

- [ ] **Определение стратегии миграции**
  - [ ] Решить между постепенной миграцией или полной реорганизацией
  - [ ] Оценить риски для работающей функциональности

## Этап 2: Создание новой структуры директорий

- [ ] **Создание основных директорий**
  - [ ] `src/core/{config,localization,logging}`
  - [ ] `src/models/dto`
  - [ ] `src/services`
  - [ ] `src/bot/utils`

- [ ] **Настройка скелета новой структуры**
  - [ ] Создать пустые `__init__.py` в каждой директории
  - [ ] Подготовить заглушки для основных файлов

## Этап 3: Реорганизация модулей доступа

- [ ] **Сравнение старой и новой реализации контроллеров доступа**
  - [ ] Детальный анализ `src/controllers/access_controller.py` и `src/db/controllers/access_controller.py`
  - [ ] Составление списка функций, которые нужно сохранить

- [ ] **Создание сервисного слоя**
  - [ ] Создать `src/services/access_service.py` с улучшенной логикой
  - [ ] Перенести бизнес-логику из контроллеров в сервис
  - [ ] Разделить ответственность между доступом к данным и бизнес-логикой

- [ ] **Реорганизация утилит доступа**
  - [ ] Создать `src/bot/utils/access_utils.py` с декораторами для бота
  - [ ] Обновить `src/utils/access_utils.py`, оставив общие функции
  - [ ] Убедиться, что нет дублирования функций

## Этап 4: Консолидация обработчиков бота

- [ ] **Анализ обработчиков запросов доступа**
  - [ ] Сравнить `src/bot/handlers/access_handlers.py` и `src/bot/handlers/access_requests.py`
  - [ ] Определить, какая версия имеет лучшую реализацию

- [ ] **Консолидация обработчиков**
  - [ ] Перенести функциональность в один файл (предпочтительно `access_handlers.py`)
  - [ ] Обновить импорты для использования нового сервисного слоя
  - [ ] Применить декораторы из нового `src/bot/utils/access_utils.py`

- [ ] **Обновление регистрации роутеров**
  - [ ] Проверить `main.py` и другие файлы, где регистрируются роутеры
  - [ ] Убедиться, что используется только одна версия роутера

## Этап 5: Реорганизация моделей данных

- [ ] **Консолидация моделей**
  - [ ] Сравнить модели в `src/storage/models.py` и `src/db/models/`
  - [ ] Создать единую структуру моделей в `src/db/models/`

- [ ] **Создание DTO (Data Transfer Objects)**
  - [ ] Определить, какие данные передаются между слоями
  - [ ] Создать DTO классы в `src/models/dto/` для чистой передачи данных

- [ ] **Обновление импортов моделей**
  - [ ] Найти все места, где используются модели
  - [ ] Обновить импорты на новые пути

## Этап 6: Настройка ядра приложения

- [ ] **Перенос конфигурации**
  - [ ] Создать централизованную систему конфигурации в `src/core/config/`
  - [ ] Перенести логику из `config/settings.py`

- [ ] **Настройка локализации**
  - [ ] Организовать систему локализации в `src/core/localization/`
  - [ ] Обеспечить совместимость с текущими вызовами локализации

- [ ] **Улучшение логирования**
  - [ ] Создать унифицированную систему логирования в `src/core/logging/`
  - [ ] Заменить разрозненное использование логгеров

## Этап 7: Тестирование и отладка

- [ ] **Проверка каждого слоя**
  - [ ] Тестирование моделей
  - [ ] Тестирование репозиториев
  - [ ] Тестирование сервисов
  - [ ] Тестирование обработчиков бота

- [ ] **Интеграционное тестирование**
  - [ ] Проверка основных сценариев использования
  - [ ] Тестирование взаимодействия компонентов

- [ ] **Исправление проблем совместимости**
  - [ ] Выявление и исправление проблем с импортами
  - [ ] Проверка совместимости типов данных

## Этап 8: Документирование

- [ ] **Обновление документации кода**
  - [ ] Добавление docstrings ко всем новым функциям и классам
  - [ ] Уточнение существующей документации

- [ ] **Создание руководства по структуре проекта**
  - [ ] Документирование новой структуры проекта
  - [ ] Объяснение паттернов и принципов организации

- [ ] **Документирование API и контрактов**
  - [ ] Описание интерфейсов между слоями
  - [ ] Документирование API эндпоинтов и обработчиков

## Этап 9: Очистка и рефакторинг

- [ ] **Удаление устаревшего кода**
  - [ ] Удаление дублирующихся файлов
  - [ ] Удаление неиспользуемых функций и классов

- [ ] **Рефакторинг для улучшения качества кода**
  - [ ] Применение принципов SOLID
  - [ ] Улучшение читаемости кода
  - [ ] Оптимизация производительности

- [ ] **Создание линтеров и проверок стиля**
  - [ ] Настройка линтеров для обеспечения соответствия стилю
  - [ ] Добавление pre-commit хуков для проверки кода

## Этап 10: Развертывание и мониторинг

- [ ] **Постепенное развертывание**
  - [ ] Сначала в тестовой среде
  - [ ] Затем в продакшн с тщательным мониторингом

- [ ] **Мониторинг работы приложения**
  - [ ] Отслеживание ошибок и производительности
  - [ ] Сбор обратной связи от пользователей

- [ ] **Улучшения после развертывания**
  - [ ] Исправление выявленных проблем
  - [ ] Дополнительная оптимизация на основе реальных данных

## Временная оценка:

- **Этапы 1-2**: 1-2 дня
- **Этапы 3-4**: 3-5 дней
- **Этапы 5-6**: 2-3 дня
- **Этап 7**: 2-4 дня
- **Этапы 8-9**: 2-3 дня
- **Этап 10**: 1-2 дня + постоянный мониторинг

**Общая оценка**: 2-3 недели при полной занятости над проектом.

## Прогресс реорганизации

- [ ] Этап 1 завершен
- [ ] Этап 2 завершен
- [ ] Этап 3 завершен
- [ ] Этап 4 завершен
- [ ] Этап 5 завершен
- [ ] Этап 6 завершен
- [ ] Этап 7 завершен
- [ ] Этап 8 завершен
- [ ] Этап 9 завершен
- [ ] Этап 10 завершен

## Примечания

Этот план можно адаптировать под конкретные условия и приоритеты. Важно начать с наиболее критичных компонентов, чтобы быстрее получить основные преимущества реорганизации. 