# Архитектурная документация Facebook Ads Telegram Bot

## 1. Обзор системы

Telegram бот для управления рекламными кампаниями в Facebook Ads представляет собой приложение, которое позволяет пользователям взаимодействовать с Facebook Marketing API через интерфейс Telegram. Система предоставляет возможности просмотра и управления рекламными аккаунтами, кампаниями и объявлениями.

## 2. Архитектурные принципы

Система построена на следующих принципах:

1. **Модульность**: каждый компонент системы выполняет отдельную задачу и может быть заменен независимо от других
2. **Разделение ответственности**: логика разделена по функциональным областям (обработчики команд, API-клиенты, утилиты и т.д.)
3. **Централизованная обработка ошибок**: единый подход к обработке и логированию исключений
4. **Многоязычность**: полная поддержка нескольких языков интерфейса
5. **Тестируемость**: компоненты спроектированы с возможностью автономного тестирования

## 3. Компоненты системы

### 3.1. Высокоуровневая структура

```
fb_ads_tg_bot/
├── src/                     # Исходный код проекта
│   ├── api/                 # Интеграция с внешними API
│   ├── bot/                 # Логика Telegram бота
│   ├── database/            # Взаимодействие с базой данных
│   ├── storage/             # Хранение данных и моделей
│   ├── utils/               # Вспомогательные утилиты
│   └── locales/             # Файлы локализации
├── tests/                   # Тесты приложения
└── config/                  # Файлы конфигурации
```

### 3.2. Ключевые компоненты и их взаимодействие

1. **Telegram Bot (src/bot/)**
   - Обработчики команд и колбэков
   - Клавиатуры и элементы интерфейса
   - Фильтры сообщений и middleware
   - Маршрутизация команд

2. **Facebook API Client (src/api/facebook/)**
   - Аутентификация и авторизация
   - Работа с аккаунтами, кампаниями и объявлениями
   - Получение статистики и инсайтов
   - Управление рекламными объектами

3. **Хранение данных (src/storage/, src/database/)**
   - Модели данных
   - Репозитории для доступа к данным
   - Сессии базы данных
   - Миграции и управление схемой

4. **Утилиты (src/utils/)**
   - Обработка ошибок
   - Логирование
   - Локализация и переводы
   - Форматирование сообщений
   - Безопасность и шифрование

5. **Система локализации (src/locales/, src/utils/localization.py)**
   - Управление переводами
   - Форматирование локализованных сообщений
   - Настройки языка пользователя

## 4. Диаграммы потоков данных

### 4.1. Базовый поток команд в Telegram боте

```
[Пользователь] → [Telegram] → [Бот (Aiogram)] → [Обработчик команды] → [Facebook API Client] → [Facebook API]
                                                ↳ [Хранилище данных] ← [База данных]
```

### 4.2. Поток авторизации в Facebook

```
[Пользователь] → [Команда /auth] → [Генерация URL] → [Пользователь проходит авторизацию на Facebook] 
                                                   ↓
[Сохранение токена] ← [Обмен кода на токен] ← [Пользователь отправляет код авторизации]
```

### 4.3. Поток получения данных о кампаниях

```
[Пользователь] → [Запрос кампаний] → [Обработчик] → [Facebook Client] → [Facebook API]
                                                   ↓
[Форматирование ответа] → [Локализация] → [Отправка сообщения пользователю]
```

## 5. Диаграммы UML и визуальные представления

### 5.1. Диаграмма классов (упрощенная)

```
┌───────────────────┐      ┌────────────────────┐      ┌─────────────────┐
│  FacebookClient   │      │    BotHandlers     │      │  LocalizationMgr │
├───────────────────┤      ├────────────────────┤      ├─────────────────┤
│- api_version      │      │- router            │      │- translations    │
│- app_id           │      │- dp                │      │- default_lang    │
│- app_secret       │      ├────────────────────┤      ├─────────────────┤
├───────────────────┤      │+ setup()           │      │+ get_text()      │
│+ get_accounts()   │      │+ cmd_start()       │      │+ set_language()  │
│+ get_campaigns()  │◄─────┤+ cmd_auth()        │◄─────┤+ get_language()  │
│+ get_ads()        │      │+ process_callback()│      └─────────────────┘
│+ get_insights()   │      └────────────────────┘             ▲
└───────────────────┘               │                         │
         ▲                          │                         │
         │                          ▼                         │
┌───────────────────┐      ┌────────────────────┐      ┌─────────────────┐
│  ErrorHandlers    │      │   DatabaseModels   │      │ MessageFormatter│
├───────────────────┤      ├────────────────────┤      ├─────────────────┤
│+ handle_exception()│      │- User              │      │+ format_stats() │
│+ api_error_handler()│     │- Account           │      │+ format_account()│
│+ db_error_handler()│◄─────┤- Campaign          │◄─────┤+ format_campaign│
└───────────────────┘      │- Ad                │      └─────────────────┘
                          └────────────────────┘
```

### 5.2. Диаграмма компонентов

```
┌─────────────────────────────────────┐
│            Telegram Bot             │
│  ┌───────────┐      ┌────────────┐  │
│  │ Handlers  │◄────►│ Callbacks  │  │
│  └───────────┘      └────────────┘  │
│         │                │          │
│         ▼                ▼          │
│  ┌───────────┐      ┌────────────┐  │
│  │ Keyboards │◄────►│   Filters  │  │
│  └───────────┘      └────────────┘  │
└─────────────────────────────────────┘
             │          ▲
             │          │
             ▼          │
┌─────────────────────────────────────┐
│          Business Logic              │
│  ┌───────────┐      ┌────────────┐  │
│  │ Facebook  │      │ Formatter  │  │
│  │   Client  │◄────►│  Service   │  │
│  └───────────┘      └────────────┘  │
│         │                │          │
│         ▼                ▼          │
│  ┌───────────┐      ┌────────────┐  │
│  │  Error    │◄────►│Localization│  │
│  │ Handlers  │      │   Service  │  │
│  └───────────┘      └────────────┘  │
└─────────────────────────────────────┘
             │          ▲
             │          │
             ▼          │
┌─────────────────────────────────────┐
│            Data Layer                │
│  ┌───────────┐      ┌────────────┐  │
│  │  Models   │◄────►│Repositories│  │
│  └───────────┘      └────────────┘  │
│         │                │          │
│         ▼                ▼          │
│  ┌───────────┐      ┌────────────┐  │
│  │  Session  │◄────►│  Database  │  │
│  │  Manager  │      │    API     │  │
│  └───────────┘      └────────────┘  │
└─────────────────────────────────────┘
```

### 5.3. Диаграмма последовательности: Запрос статистики кампании

```
┌───────────┐  ┌────────┐  ┌─────────┐  ┌────────────┐  ┌─────────┐  ┌─────────┐
│Пользователь│  │Telegram│  │  Бот    │  │ Facebook   │  │ База    │  │Форматтер│
│           │  │        │  │         │  │ API Client │  │ данных  │  │         │
└─────┬─────┘  └───┬────┘  └────┬────┘  └─────┬──────┘  └────┬────┘  └────┬────┘
      │            │            │              │              │            │
      │ /campaign  │            │              │              │            │
      │────────────┼────────────►              │              │            │
      │            │            │              │              │            │
      │            │     проверка авторизации  │              │            │
      │            │            │─────────────┐│              │            │
      │            │            │<────────────┘│              │            │
      │            │            │              │              │            │
      │            │            │ запрос токена│              │            │
      │            │            │──────────────┼──────────────►            │
      │            │            │              │              │            │
      │            │            │              │   токен      │            │
      │            │            │              │◄─────────────┼────────────│
      │            │            │              │              │            │
      │            │            │ запрос кампаний             │            │
      │            │            │──────────────►              │            │
      │            │            │              │              │            │
      │            │            │     данные кампаний         │            │
      │            │            │◄─────────────┤              │            │
      │            │            │              │              │            │
      │            │            │ форматирование и локализация │            │
      │            │            │─────────────────────────────┼────────────►
      │            │            │              │              │            │
      │            │            │              │          форматированный ответ
      │            │            │◄─────────────┼──────────────┼────────────┤
      │            │            │              │              │            │
      │  ответ     │            │              │              │            │
      │◄───────────┼────────────┤              │              │            │
      │            │            │              │              │            │
```

## 6. Ключевые процессы

### 6.1. Обработка команд

1. Пользователь отправляет команду в Telegram
2. Aiogram перенаправляет команду соответствующему обработчику
3. Обработчик выполняет бизнес-логику (часто с обращением к Facebook API)
4. Результат форматируется и локализуется
5. Ответ отправляется пользователю

### 6.2. Авторизация пользователя

1. Пользователь запрашивает авторизацию командой `/auth`
2. Система генерирует URL для авторизации с CSRF-токеном
3. Пользователь переходит по URL и авторизуется в Facebook
4. Facebook возвращает пользователя с кодом авторизации
5. Пользователь отправляет код боту
6. Бот обменивает код на долговременный токен
7. Токен сохраняется в базе данных для дальнейшего использования

### 6.3. Работа с обработкой ошибок

1. Все обработчики команд декорируются `@handle_exceptions`
2. При возникновении исключения срабатывает обработчик
3. Ошибка логируется с контекстом выполнения
4. Пользователь получает локализованное сообщение об ошибке
5. В зависимости от типа ошибки может быть предпринято дополнительное действие

## 7. Технические решения и ограничения

### 7.1. Выбор технологий

- **Язык программирования**: Python 3.10+
- **Фреймворк для Telegram**: Aiogram
- **Facebook API**: facebook_business
- **База данных**: SQLite (разработка), PostgreSQL (продакшн)
- **ORM**: SQLAlchemy
- **Работа с HTTP**: aiohttp
- **Локализация**: Собственная реализация на основе JSON-файлов

### 7.2. Ограничения системы

- **Лимиты Facebook API**: Система учитывает ограничения на количество запросов к Facebook API
- **Масштабируемость**: Текущая архитектура поддерживает ограниченное количество одновременных пользователей
- **Память**: SQLite имеет ограничения по объему и нагрузке, для высоких нагрузок рекомендуется PostgreSQL
- **Telegram API**: Учитываются ограничения на размер сообщений и частоту отправки

### 7.3. Направления для улучшения

- Переход на асинхронную работу с базой данных
- Кэширование результатов API-запросов
- Распределенная архитектура с очередями сообщений
- Интеграция системы мониторинга и предупреждений
- Автоматическое масштабирование ресурсов

## 8. Безопасность

- **OAuth 2.0**: Используется для авторизации с Facebook
- **CSRF-защита**: Реализована при обмене авторизационного кода
- **Хранение токенов**: Токены хранятся в зашифрованном виде
- **Изоляция окружений**: Разделение конфигурации для разработки, тестирования и продакшна
- **Валидация вводимых данных**: Проверка всех данных, получаемых от пользователя 