# План рефакторинга для централизации управления состоянием

## Этап 1: Создание базовой структуры ✅
- [x] 1.1. Создание модуля `src/state/` для централизованного управления состоянием
- [x] 1.2. Внедрение класса `UserSession` для работы с состоянием пользователя

## Этап 2: Рефакторинг существующего кода
- [ ] 2.1. Обновление обработчиков команд в `src/bot/handlers/` для использования нового модуля
  - [ ] 2.1.1. Рефакторинг `main.py`
  - [ ] 2.1.2. Рефакторинг `account.py`
  - [ ] 2.1.3. Рефакторинг `campaign.py`
  - [ ] 2.1.4. Рефакторинг `ad.py`
  - [ ] 2.1.5. Рефакторинг `auth.py`
- [ ] 2.2. Обновление колбэков в `src/bot/callbacks/` для использования нового модуля
  - [ ] 2.2.1. Рефакторинг `menu_callbacks.py`
  - [ ] 2.2.2. Рефакторинг `account_callbacks.py`
  - [ ] 2.2.3. Рефакторинг `stats_callbacks.py`
  - [ ] 2.2.4. Рефакторинг `export_callbacks.py`

## Этап 3: Оптимизация работы с базой данных
- [ ] 3.1. Добавление методов пакетной обработки и кэширования
- [ ] 3.2. Оптимизация запросов к базе данных
- [ ] 3.3. Реализация механизма обновления кэша

## Этап 4: Внедрение дополнительной функциональности
- [ ] 4.1. Добавление управления пользовательскими настройками
- [ ] 4.2. Разработка системы для отслеживания прогресса пользователя
- [ ] 4.3. Реализация механизма для работы с историей команд

## Этап 5: Тестирование и документация
- [ ] 5.1. Разработка тестов для нового модуля
- [ ] 5.2. Создание документации и примеров использования
- [ ] 5.3. Обновление общей документации проекта

## Примеры использования нового модуля

### Получение и установка значений контекста
```python
# Инициализация сессии
user_session = await UserSession.get_session(message.from_user.id)

# Получение текущего аккаунта
account_id = user_session.get_current_account()

# Установка текущего аккаунта
user_session.set_current_account(account_id)
```

### Проверка токена и языковых настроек
```python
# Проверка валидности токена
is_valid = user_session.is_token_valid()
if not is_valid:
    await message.answer("Ваш токен истек. Пожалуйста, авторизуйтесь заново с помощью /auth")
    return

# Получение языковых настроек
language = user_session.get_language()
```

### Работа с контекстом для сложных сценариев
```python
# Загрузка контекста целиком
context = user_session.get_context()

# Обновление нескольких полей
user_session.set_context({
    "last_viewed_account": account_id,
    "last_viewed_campaign": campaign_id,
    "selected_date_range": "last_7d"
})

# Очистка контекста при завершении сессии
user_session.clear_context()
```

## Контрольные точки

- [ ] Базовая структура модуля создана
- [ ] Рефакторинг обработчиков команд завершен
- [ ] Рефакторинг колбэков завершен
- [ ] Оптимизация работы с БД завершена
- [ ] Дополнительная функциональность внедрена
- [ ] Тесты и документация завершены 