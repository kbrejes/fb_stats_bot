name: üöÄ Quick Bot Restart

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  restart:
    name: üöÄ –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üöÄ –ë–´–°–¢–†–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö FACEBOOK ADS BOT"
            echo "====================================="
            
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean
            
            echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
            pwd
            ls -la
            
            echo ""
            echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .env.prod —Ñ–∞–π–ª–∞:"
            if [ -f .env.prod ]; then
                echo "‚úÖ .env.prod –Ω–∞–π–¥–µ–Ω"
                echo "–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫:"
                head -5 .env.prod
            else
                echo "‚ùå .env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º..."
                cat > .env.prod << 'EOF'
            ENVIRONMENT=production
            TELEGRAM_TOKEN=7595294156:AAFcKTYzTt0h0xEt-BiVs-otrmYB6dAL7LY
            OWNER_ID=400133981
            OWNER_USERNAME=kbrejes
            OWNER_FIRST_NAME=Kiryushaa
            ADMIN_USERS=400133981
            FB_APP_ID=639419165542707
            FB_APP_SECRET=73af4e475afddfbd61fb74628481eb28
            FB_REDIRECT_URI=https://188.166.221.59/api/facebook/callback
            FB_API_VERSION=v19.0
            OPENAI_API_KEY=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
            DB_CONNECTION_STRING=postgresql://fb_ads_user:secure_password_123@localhost:5432/fb_ads_bot_prod
            DB_PATH=data/bot_production.db
            ENCRYPTION_KEY=cf3d1c3258968545324a5e02c52c9f1cdf52f0ba5c68bdc1a934482a29402691
            LOG_LEVEL=INFO
            DEBUG=False
            LOG_FILE=logs/bot_production.log
            ERROR_LOG_FILE=logs/error_production.log
            PRODUCTION_DOMAIN=188.166.221.59
            PRODUCTION_PORT=8000
            HEALTH_CHECK_URL=http://localhost:8080/health
            EOF
                echo "‚úÖ .env.prod —Å–æ–∑–¥–∞–Ω"
            fi
            
            echo ""
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            echo ""
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker:"
            docker system prune -f
            
            echo ""
            echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤:"
            docker-compose -f docker-compose.prod.yml up -d
            
            echo ""
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo ""
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo ""
            echo "üìã –õ–æ–≥–∏ –±–æ—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
            docker logs fb_ads_bot_app --tail=20 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üè• Health check:"
            curl -f http://localhost:8080/health 2>/dev/null && echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Health endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            
            echo ""
            echo "‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!" 