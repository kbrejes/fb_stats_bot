name: üî¨ Deep Diagnosis

on:
  workflow_dispatch:

jobs:
  deep-diagnosis:
    runs-on: ubuntu-latest
    steps:
      - name: üî¨ Deep Server Diagnosis
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üî¨ –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ï–†–í–ï–†–ê"
            echo "================================"
            
            echo "üìä –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:"
            echo "–î–∞—Ç–∞: $(date)"
            echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
            echo "–î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $HOME"
            echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            
            echo -e "\nüíæ –î–ò–°–ö–û–í–û–ï –ü–†–û–°–¢–†–ê–ù–°–¢–í–û:"
            df -h
            
            echo -e "\nüß† –ü–ê–ú–Ø–¢–¨:"
            free -h
            
            echo -e "\n‚ö° –ü–†–û–¶–ï–°–°–´:"
            ps aux | head -10
            
            echo -e "\nüåê –°–ï–¢–ï–í–´–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø:"
            netstat -tlnp | grep -E ':(22|80|443|8000|8080|5432)'
            
            echo -e "\nüê≥ DOCKER –°–¢–ê–¢–£–°:"
            docker --version
            docker-compose --version
            docker info | grep -E "(Containers|Images|Server Version)"
            
            echo -e "\nüì¶ DOCKER –ö–û–ù–¢–ï–ô–ù–ï–†–´:"
            docker ps -a
            
            echo -e "\nüñºÔ∏è DOCKER –û–ë–†–ê–ó–´:"
            docker images
            
            echo -e "\nüìÅ –ü–û–ò–°–ö –î–ò–†–ï–ö–¢–û–†–ò–ô –ü–†–û–ï–ö–¢–ê:"
            find /home -name "*fb_ads*" -type d 2>/dev/null || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ /home"
            find /root -name "*fb_ads*" -type d 2>/dev/null || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ /root"
            find /opt -name "*fb_ads*" -type d 2>/dev/null || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ /opt"
            
            echo -e "\nüìÇ –ü–†–û–í–ï–†–ö–ê –í–û–ó–ú–û–ñ–ù–´–• –î–ò–†–ï–ö–¢–û–†–ò–ô:"
            for dir in "/home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean" "/root/fb_ads_tg_bot_clean" "/home/root/fb_ads_tg_bot_clean"; do
              if [ -d "$dir" ]; then
                echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞: $dir"
                ls -la "$dir" | head -10
                echo "Git —Å—Ç–∞—Ç—É—Å:"
                cd "$dir" && git status 2>/dev/null || echo "–ù–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
                echo "Docker compose —Ñ–∞–π–ª—ã:"
                ls -la "$dir"/docker-compose* 2>/dev/null || echo "–ù–µ—Ç docker-compose —Ñ–∞–π–ª–æ–≤"
                echo "Env —Ñ–∞–π–ª—ã:"
                ls -la "$dir"/.env* 2>/dev/null || echo "–ù–µ—Ç .env —Ñ–∞–π–ª–æ–≤"
                echo "---"
              else
                echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞: $dir"
              fi
            done
            
            echo -e "\nüîç –ü–û–ò–°–ö DOCKER-COMPOSE –§–ê–ô–õ–û–í:"
            find / -name "docker-compose*.yml" -type f 2>/dev/null | head -10
            
            echo -e "\nüìã –õ–û–ì–ò DOCKER:"
            docker logs $(docker ps -aq) --tail=5 2>/dev/null || echo "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            
            echo -e "\nüî• –°–ò–°–¢–ï–ú–ù–´–ï –õ–û–ì–ò (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏):"
            journalctl --no-pager -n 20 -p err 2>/dev/null || echo "journalctl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo -e "\nüö™ –û–¢–ö–†–´–¢–´–ï –ü–û–†–¢–´:"
            ss -tlnp | grep -E ':(22|80|443|8000|8080|5432)' || echo "–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤"
            
            echo -e "\nüîê FIREWALL –°–¢–ê–¢–£–°:"
            ufw status 2>/dev/null || iptables -L -n | head -10 2>/dev/null || echo "Firewall info –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo -e "\nüìä –ó–ê–ì–†–£–ó–ö–ê –°–ò–°–¢–ï–ú–´:"
            uptime
            
            echo -e "\n‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê" 