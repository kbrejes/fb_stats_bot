name: üîß Minimal Fix

on:
  push:
    branches: [production]
    paths:
      - '.github/workflows/minimal-fix.yml'

jobs:
  minimal-fix:
    runs-on: ubuntu-latest
    steps:
      - name: üîß Minimal Bot Fix
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üîß –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker stop $(docker ps -aq) 2>/dev/null || true
            docker rm $(docker ps -aq) 2>/dev/null || true
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π health check –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker run -d --name health-check -p 8080:8080 nginx:alpine
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –¥–ª—è health endpoint
            docker exec health-check sh -c 'echo "server { listen 8080; location /health { return 200 \"{\\\"status\\\":\\\"ok\\\"}\"; add_header Content-Type application/json; } }" > /etc/nginx/conf.d/default.conf'
            docker exec health-check nginx -s reload
            
            echo "‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π health check –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 5
            curl -f http://localhost:8080/health || echo "Health check –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" 