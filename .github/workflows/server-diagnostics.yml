name: üîç Server Diagnostics

on:
  workflow_dispatch:
    inputs:
      diagnostic_type:
        description: '–¢–∏–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - logs
          - status
          - restart

permissions:
  contents: read

jobs:
  diagnose:
    name: üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        if: github.event.inputs.diagnostic_type == 'full' || github.event.inputs.diagnostic_type == ''
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ï–†–í–ï–†–ê"
            echo "=============================="
            
            echo "üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
            echo "------------------------"
            uname -a
            uptime
            df -h
            free -h
            
            echo ""
            echo "üê≥ Docker —Å—Ç–∞—Ç—É—Å:"
            echo "----------------"
            docker --version
            docker-compose --version
            docker ps -a
            
            echo ""
            echo "üìÅ –ü—Ä–æ–µ–∫—Ç:"
            echo "---------"
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean
            pwd
            ls -la
            
            echo ""
            echo "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
            echo "---------------"
            ls -la .env* 2>/dev/null || echo "–§–∞–π–ª—ã .env –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo "–ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ .env.prod:"
            head -10 .env.prod 2>/dev/null || echo "–§–∞–π–ª .env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üîß Docker Compose —Å—Ç–∞—Ç—É—Å:"
            echo "------------------------"
            docker-compose -f docker-compose.prod.yml ps 2>/dev/null || echo "docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üåê –°–µ—Ç–µ–≤—ã–µ –ø–æ—Ä—Ç—ã:"
            echo "----------------"
            netstat -tlnp | grep -E ':(8000|8080|5432|6379)' || echo "–¶–µ–ª–µ–≤—ã–µ –ø–æ—Ä—Ç—ã –Ω–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—é—Ç—Å—è"
            
            echo ""
            echo "‚ö° –ü—Ä–æ—Ü–µ—Å—Å—ã:"
            echo "----------"
            ps aux | grep -E '(python|docker|postgres|redis)' | grep -v grep || echo "–¶–µ–ª–µ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

      - name: üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
        if: github.event.inputs.diagnostic_type == 'logs' || github.event.inputs.diagnostic_type == 'full'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üìã –õ–û–ì–ò –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
            echo "=================="
            
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean
            
            echo "ü§ñ –õ–æ–≥–∏ –±–æ—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫):"
            echo "-----------------------------------"
            docker logs fb_ads_bot_app --tail=30 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä fb_ads_bot_app –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üóÑÔ∏è –õ–æ–≥–∏ PostgreSQL:"
            echo "------------------"
            docker logs fb_ads_bot_postgres --tail=20 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üî¥ –õ–æ–≥–∏ Redis:"
            echo "-------------"
            docker logs fb_ads_bot_redis --tail=10 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Redis –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üåê –õ–æ–≥–∏ Nginx:"
            echo "-------------"
            docker logs fb_ads_bot_nginx --tail=10 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üìÅ –§–∞–π–ª—ã –ª–æ–≥–æ–≤:"
            echo "--------------"
            ls -la logs/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            
            if [ -f logs/bot_production.log ]; then
                echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ bot_production.log:"
                tail -20 logs/bot_production.log
            fi
            
            if [ -f logs/error_production.log ]; then
                echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ error_production.log:"
                tail -10 logs/error_production.log
            fi

      - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        if: github.event.inputs.diagnostic_type == 'status'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üìä –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í"
            echo "=================="
            
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean
            
            echo "üê≥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker ps -a
            
            echo ""
            echo "üîß Docker Compose —Å—Ç–∞—Ç—É—Å:"
            docker-compose -f docker-compose.prod.yml ps 2>/dev/null || echo "docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üåê Health checks:"
            curl -f http://localhost:8080/health 2>/dev/null && echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Health endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            curl -f http://localhost:8000 2>/dev/null && echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ä—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

      - name: üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
        if: github.event.inputs.diagnostic_type == 'restart'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í"
            echo "====================="
            
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean
            
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            docker-compose -f docker-compose.prod.yml down
            
            echo ""
            echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            docker-compose -f docker-compose.prod.yml up -d
            
            echo ""
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo ""
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo ""
            echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint:"
            curl -f http://localhost:8080/health 2>/dev/null && echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Health endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç" 