name: üö® Emergency Fix

on:
  workflow_dispatch:

jobs:
  emergency-fix:
    runs-on: ubuntu-latest
    steps:
      - name: üö® Emergency Bot Fix
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–û–¢–ê"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean 2>/dev/null || cd /root/fb_ads_tg_bot_clean 2>/dev/null || {
              echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º..."
              mkdir -p /root/fb_ads_tg_bot_clean
              cd /root/fb_ads_tg_bot_clean
              git clone https://github.com/kbrejes/fb_stats_bot.git .
            }
            
            echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker stop $(docker ps -aq) 2>/dev/null || true
            docker rm $(docker ps -aq) 2>/dev/null || true
            docker system prune -af
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
            git fetch origin
            git reset --hard origin/production
            
            # –°–æ–∑–¥–∞–µ–º .env.prod
            echo "üìù –°–æ–∑–¥–∞–µ–º .env.prod..."
            cat > .env.prod << 'EOF'
            ENVIRONMENT=production
            TELEGRAM_TOKEN=7595294156:AAFcKTYzTt0h0xEt-BiVs-otrmYB6dAL7LY
            OWNER_ID=400133981
            OWNER_USERNAME=kbrejes
            OWNER_FIRST_NAME=Kiryushaa
            ADMIN_USERS=400133981
            FB_APP_ID=639419165542707
            FB_APP_SECRET=73af4e475afddfbd61fb74628481eb28
            FB_REDIRECT_URI=https://188.166.221.59/api/facebook/callback
            FB_API_VERSION=v19.0
            OPENAI_API_KEY=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
            ENCRYPTION_KEY=cf3d1c3258968545324a5e02c52c9f1cdf52f0ba5c68bdc1a934482a29402691
            DB_CONNECTION_STRING=postgresql://fb_ads_user:secure_password_123@localhost:5432/fb_ads_bot_prod
            LOG_LEVEL=INFO
            DEBUG=False
            EOF
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
            mkdir -p logs data backups
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã..."
            docker-compose -f docker-compose.prod.yml up -d postgres redis bot
            
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ (60 —Å–µ–∫—É–Ω–¥)..."
            sleep 60
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker ps
            
            echo "üìã –õ–æ–≥–∏ –±–æ—Ç–∞:"
            docker logs fb_ads_bot_app --tail=30 2>/dev/null || docker logs bot --tail=30 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            
            echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health:"
            curl -f http://localhost:8080/health 2>/dev/null && echo "‚úÖ Health OK" || echo "‚ùå Health failed"
            
            echo "‚úÖ –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!" 