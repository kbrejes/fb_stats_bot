name: üîß Fix Bot

on:
  workflow_dispatch:

jobs:
  fix-bot:
    runs-on: ubuntu-latest
    steps:
      - name: üîß Fix Bot on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã..."
            
            cd /home/${{ secrets.PROD_USER }}/fb_ads_tg_bot_clean || cd /root/fb_ads_tg_bot_clean
            
            echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
            pwd
            ls -la
            
            echo "üê≥ –°—Ç–∞—Ç—É—Å Docker:"
            docker --version
            docker-compose --version
            
            echo "üìä –¢–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker ps -a
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º docker-compose —Ñ–∞–π–ª—ã:"
            ls -la docker-compose*
            
            echo "üîß –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker stop $(docker ps -aq) 2>/dev/null || true
            docker rm $(docker ps -aq) 2>/dev/null || true
            
            echo "üßπ –û—á–∏—â–∞–µ–º Docker:"
            docker system prune -f
            
            echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º .env.prod:"
            if [ -f ".env.prod" ]; then
              echo "‚úÖ .env.prod —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              head -5 .env.prod
            else
              echo "‚ùå .env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º..."
              cat > .env.prod << 'EOF'
            ENVIRONMENT=production
            TELEGRAM_TOKEN=7595294156:AAFcKTYzTt0h0xEt-BiVs-otrmYB6dAL7LY
            OWNER_ID=400133981
            FB_APP_ID=639419165542707
            FB_APP_SECRET=73af4e475afddfbd61fb74628481eb28
            FB_REDIRECT_URI=https://188.166.221.59/api/facebook/callback
            OPENAI_API_KEY=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
            ENCRYPTION_KEY=cf3d1c3258968545324a5e02c52c9f1cdf52f0ba5c68bdc1a934482a29402691
            DB_CONNECTION_STRING=postgresql://fb_ads_user:secure_password_123@localhost:5432/fb_ads_bot_prod
            LOG_LEVEL=INFO
            EOF
            fi
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            if [ -f "docker-compose.prod.yml" ]; then
              docker-compose -f docker-compose.prod.yml up -d
            elif [ -f "docker-compose.yml" ]; then
              docker-compose up -d
            else
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω docker-compose —Ñ–∞–π–ª!"
              exit 1
            fi
            
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫)..."
            sleep 30
            
            echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
            docker ps
            
            echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            docker logs $(docker ps --format "table {{.Names}}" | grep -E "(app|bot)" | head -1) --tail=20 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            
            echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health:"
            curl -f http://localhost:8080/health || echo "Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" 