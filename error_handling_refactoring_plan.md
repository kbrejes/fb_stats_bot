# План рефакторинга для улучшения обработки ошибок

## Цели рефакторинга
1. Централизовать обработку ошибок
2. Унифицировать подход к обработке исключений
3. Улучшить пользовательский опыт при возникновении ошибок
4. Облегчить отладку и мониторинг ошибок
5. Повысить стабильность и устойчивость бота

## Этап 1: Создание базовой структуры
- [ ] 1.1. Создание модуля `src/utils/error_handlers.py`
- [ ] 1.2. Определение основных классов исключений
- [ ] 1.3. Разработка базовых обработчиков ошибок

## Этап 2: Разработка компонентов системы обработки ошибок
- [ ] 2.1. Реализация обработчиков ошибок API Facebook
  - [ ] 2.1.1. Обработка ошибок авторизации
  - [ ] 2.1.2. Обработка ошибок ограничения запросов (rate limiting)
  - [ ] 2.1.3. Обработка сетевых ошибок
  - [ ] 2.1.4. Обработка ошибок бизнес-логики
- [ ] 2.2. Реализация обработчиков ошибок Telegram API
  - [ ] 2.2.1. Обработка ошибок отправки сообщений
  - [ ] 2.2.2. Обработка ошибок обновления сообщений
  - [ ] 2.2.3. Обработка ошибок прав доступа
- [ ] 2.3. Реализация обработчиков ошибок базы данных
  - [ ] 2.3.1. Обработка ошибок подключения
  - [ ] 2.3.2. Обработка ошибок транзакций
  - [ ] 2.3.3. Обработка ошибок запросов

## Этап 3: Интеграция с существующим кодом
- [ ] 3.1. Рефакторинг клиента Facebook API
  - [ ] 3.1.1. Внедрение централизованных обработчиков ошибок
  - [ ] 3.1.2. Унификация возвращаемых ошибок
- [ ] 3.2. Рефакторинг обработчиков команд бота
  - [ ] 3.2.1. Внедрение централизованных обработчиков ошибок
  - [ ] 3.2.2. Унификация сообщений об ошибках
- [ ] 3.3. Рефакторинг колбэков бота
  - [ ] 3.3.1. Внедрение централизованных обработчиков ошибок
  - [ ] 3.3.2. Обработка ошибок при выполнении колбэков

## Этап 4: Система логирования и мониторинга ошибок
- [ ] 4.1. Разработка системы структурированного логирования ошибок
- [ ] 4.2. Добавление контекста к сообщениям об ошибках
- [ ] 4.3. Механизм отправки критических ошибок администратору

## Этап 5: Повышение удобства использования и информативность ошибок
- [ ] 5.1. Создание шаблонов пользовательских сообщений для разных типов ошибок
- [ ] 5.2. Внедрение рекомендаций по исправлению ошибок пользователем
- [ ] 5.3. Поддержка мультиязычности для сообщений об ошибках

## Структура системы обработки ошибок

### Классы исключений
```python
class BotBaseError(Exception):
    """Базовый класс исключений для бота."""
    def __init__(self, message, code=None, user_message=None):
        self.message = message  # Техническое сообщение
        self.code = code  # Код ошибки
        self.user_message = user_message  # Сообщение для пользователя
        super().__init__(self.message)

class APIError(BotBaseError):
    """Ошибки внешних API."""
    pass

class FacebookAPIError(APIError):
    """Ошибки Facebook API."""
    pass

class TelegramAPIError(APIError):
    """Ошибки Telegram API."""
    pass

class DatabaseError(BotBaseError):
    """Ошибки базы данных."""
    pass

class UserError(BotBaseError):
    """Ошибки, связанные с действиями пользователя."""
    pass
```

### Обработчики ошибок
```python
async def handle_api_error(error, user_id=None, message=None):
    """
    Обработка ошибок API.
    
    Args:
        error: Исключение
        user_id: ID пользователя
        message: Объект сообщения для ответа пользователю
    """
    # Логирование ошибки
    logger.error(f"API Error: {error.message}, Code: {error.code}")
    
    # Отправка сообщения пользователю
    if message and error.user_message:
        await message.answer(error.user_message)
        
    # Дополнительные действия при необходимости
    # ...

async def handle_database_error(error, user_id=None, message=None):
    """
    Обработка ошибок базы данных.
    
    Args:
        error: Исключение
        user_id: ID пользователя
        message: Объект сообщения для ответа пользователю
    """
    # Реализация обработки...
```

### Декораторы для обработки ошибок
```python
def catch_errors(func):
    """
    Декоратор для перехвата и обработки ошибок в обработчиках команд.
    """
    @functools.wraps(func)
    async def wrapper(message, *args, **kwargs):
        try:
            return await func(message, *args, **kwargs)
        except FacebookAPIError as e:
            await handle_api_error(e, message.from_user.id, message)
        except DatabaseError as e:
            await handle_database_error(e, message.from_user.id, message)
        except Exception as e:
            # Общий обработчик неожиданных ошибок
            logger.exception(f"Unexpected error in {func.__name__}: {str(e)}")
            await message.answer("Произошла непредвиденная ошибка. Попробуйте позже.")
    return wrapper
```

## Примеры использования

### Генерация ошибок
```python
# В клиенте Facebook API
if 'error' in response:
    error_data = response['error']
    raise FacebookAPIError(
        message=error_data.get('message', 'Unknown Facebook API error'),
        code=error_data.get('code'),
        user_message="Ошибка при работе с Facebook API. Попробуйте позже."
    )
```

### Обработка ошибок
```python
@router.message(Command("campaigns"))
@catch_errors
async def cmd_campaigns(message: Message, command: CommandObject = None):
    """
    Получение кампаний с централизованной обработкой ошибок через декоратор.
    """
    # Код обработчика команды...
```

### Прямой вызов обработчиков
```python
try:
    # Код, который может вызвать ошибку
    campaigns = await fb_client.get_campaigns(account_id)
except FacebookAPIError as e:
    # Явный вызов обработчика ошибок
    await handle_api_error(e, user_id, message)
    return
```

## Контрольные точки
- [ ] Базовая структура системы обработки ошибок
- [ ] Обработчики специфических ошибок для Facebook API
- [ ] Обработчики специфических ошибок для Telegram API
- [ ] Обработчики ошибок базы данных
- [ ] Рефакторинг клиента Facebook API
- [ ] Рефакторинг обработчиков команд бота
- [ ] Усовершенствованное логирование ошибок
- [ ] Локализация сообщений об ошибках 