# План рефакторинга: Документация и типизация

## Обзор
Этот план описывает процесс добавления интерфейсов и типов данных для улучшения типизации, документации и последующей поддержки кода. Четкая типизация улучшит обнаружение ошибок на этапе разработки и сделает код более понятным.

## Цели
- Создать четкие интерфейсы для API компонентов
- Определить типы данных, используемые в боте
- Улучшить документацию кода с помощью type hints
- Обеспечить согласованность типов данных между модулями

## Шаги рефакторинга

### 1. Анализ текущей структуры кода
- Выявить основные объекты данных, используемые в боте
- Определить общие структуры данных в разных модулях
- Проанализировать интерфейсы API компонентов

### 2. Создание файла интерфейсов API (src/api/interfaces.py)
- Определить основные интерфейсы для Facebook API:
  - `FacebookAdsClientInterface` - интерфейс для клиента API
  - `AccountService` - интерфейс для работы с аккаунтами
  - `CampaignService` - интерфейс для работы с кампаниями
  - `AdService` - интерфейс для работы с объявлениями
  - `InsightService` - интерфейс для работы со статистикой
- Описать методы каждого интерфейса с полной типизацией
- Документировать интерфейсы с использованием docstrings

### 3. Создание файла типов для бота (src/bot/types.py)
- Определить основные типы данных бота:
  - Типы для моделей данных (Account, Campaign, Ad, Insight)
  - Типы для ответов API
  - Типы для callback-данных
  - Типы для FSM состояний и контекста
  - Типы для клавиатур и меню
- Добавить алиасы для часто используемых типов (например, `UserId = int`)
- Документировать типы с использованием docstrings

### 4. Обновление существующего кода для использования интерфейсов
- Обновить реализации классов Facebook API для использования интерфейсов
- Добавить аннотации типов к методам и функциям
- Обеспечить полное соответствие реализаций определенным интерфейсам

### 5. Обновление обработчиков бота для использования типов
- Добавить типизацию для обработчиков команд
- Типизировать callback-обработчики
- Добавить типизацию для клавиатур и markup-объектов

### 6. Добавление проверки типов
- Настроить mypy для проверки типов
- Добавить конфигурацию mypy в проект
- Решить выявленные проблемы типизации

### 7. Документирование и тестирование
- Убедиться, что все публичные методы имеют документацию
- Проверить, что интерфейсы правильно отражают текущую функциональность
- Протестировать обратную совместимость

## Технические детали

### Для src/api/interfaces.py
```python
from typing import Protocol, List, Dict, Any, Optional, Union

class FacebookAdsClientInterface(Protocol):
    """Интерфейс для работы с Facebook Ads API."""
    
    async def get_ad_accounts(self) -> List[Dict[str, Any]]:
        """Получает список доступных рекламных аккаунтов."""
        ...
    
    async def get_campaigns(self, account_id: str) -> List[Dict[str, Any]]:
        """Получает список кампаний для указанного аккаунта."""
        ...
    
    # Другие методы...
```

### Для src/bot/types.py
```python
from typing import TypedDict, Dict, List, Any, Union, Optional, Literal

# User IDs
UserId = int
TelegramId = int

# API структуры данных
class AccountData(TypedDict):
    id: str
    name: str
    status: str
    account_status: int
    currency: str
    timezone_name: str
    # другие поля...

# Callback data
CallbackData = str
AccountCallbackData = str
# другие типы...
```

## Риски и их снижение
- **Риск**: Несовместимость с существующим кодом
  - **Снижение**: Постепенное внедрение типизации без изменения логики
- **Риск**: Излишнее усложнение кода
  - **Снижение**: Фокус на ключевых интерфейсах, без избыточной типизации
- **Риск**: Проблемы с библиотеками без типизации
  - **Снижение**: Использование Optional и Any где необходимо

## Критерии завершения
- Созданы и документированы интерфейсы для API компонентов
- Определены и документированы типы данных для бота
- Код проходит проверку mypy без критических ошибок
- Тесты подтверждают работоспособность кода с новой типизацией 